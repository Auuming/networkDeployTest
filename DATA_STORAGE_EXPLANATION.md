# Data Storage Explanation
## How Socket IDs and Other Data Are Stored

---

## üìç **Overview**

This document explains where and how all data (socket IDs, clients, groups, messages, rooms) is stored in the application, including the specific files and data structures used.

---

## üñ•Ô∏è **SERVER-SIDE STORAGE** (`server/server.js`)

### **File Location**: `server/server.js` (Lines 49-54)

All server-side data is stored in **in-memory data structures** (Maps and Sets) that persist only while the server is running.

### **1. Clients Storage**

**Data Structure**: `Map<string, ClientObject>`
- **Key**: `socket.id` (unique socket ID generated by Socket.IO)
- **Value**: Client object with `name`, `socketId`, `age`

**Code Location**:
```49:49:server/server.js
const clients = new Map();
```

**How Socket ID is Stored**:
```82:86:server/server.js
    clients.set(socket.id, {
      name: clientName.trim(),
      socketId: socket.id,
      age: age,
    });
```

**Structure**:
```javascript
clients = Map {
  "socket-id-1" => { name: "Alice", socketId: "socket-id-1", age: 25 },
  "socket-id-2" => { name: "Bob", socketId: "socket-id-2", age: 30 },
  ...
}
```

**Usage Examples**:
- Get client by socket ID: `clients.get(socket.id)`
- Check if name exists: `Array.from(clients.values()).some(...)`
- Delete on disconnect: `clients.delete(socket.id)`

---

### **2. Groups Storage**

**Data Structure**: `Map<string, GroupObject>`
- **Key**: `groupId` (e.g., `"group-1"`, `"group-2"`)
- **Value**: Group object with `name`, `creator`, `members` (Set), `minimumAge`

**Code Location**:
```50:50:server/server.js
const groups = new Map();
```

**How Socket IDs are Stored in Groups**:
```214:232:server/server.js
    const groupId = `group-${groupIdCounter++}`;
    const group = {
      name: groupName.trim(),
      creator: {
        name: creator.name,
        socketId: socket.id,
        age: creator.age,
      },
      members: new Set([socket.id]), // Socket IDs stored in Set
      minimumAge: minimumAge,
    };

    groups.set(groupId, group);
```

**Structure**:
```javascript
groups = Map {
  "group-1" => {
    name: "Study Group",
    creator: { name: "Alice", socketId: "socket-id-1", age: 25 },
    members: Set { "socket-id-1", "socket-id-2" }, // Socket IDs in Set
    minimumAge: 18
  },
  ...
}
```

**Key Points**:
- `members` is a **Set** of socket IDs (not objects)
- Socket IDs are used to check membership: `group.members.has(socket.id)`
- Socket IDs are added when joining: `group.members.add(socket.id)`

---

### **3. Private Rooms Storage**

**Data Structure**: `Map<string, RoomObject>`
- **Key**: `roomId` (sorted socket IDs joined: `"socket1-socket2"`)
- **Value**: Room object with `participants` (Set of socket IDs)

**Code Location**:
```52:52:server/server.js
const privateRooms = new Map();
```

**How Socket IDs are Stored**:
```139:145:server/server.js
    const roomId = [socket.id, recipientId].sort().join("-");

    if (!privateRooms.has(roomId)) {
      privateRooms.set(roomId, {
        participants: new Set([socket.id, recipientId]),
      });
    }
```

**Structure**:
```javascript
privateRooms = Map {
  "socket-id-1-socket-id-2" => {
    participants: Set { "socket-id-1", "socket-id-2" }
  },
  ...
}
```

**Key Points**:
- Room ID is created by sorting and joining two socket IDs
- `participants` is a **Set** containing socket IDs
- Ensures same room ID regardless of sender/receiver order

---

### **4. Messages Storage**

**Data Structure**: `Map<string, MessageMetadata>`
- **Key**: `messageId` (e.g., `"msg-1"`, `"msg-2"`)
- **Value**: Message metadata with `roomId`/`groupId`, `type`, `reactions`

**Code Location**:
```53:53:server/server.js
const messages = new Map();
```

**How Socket IDs are Stored in Messages**:
```167:170:server/server.js
    messages.set(messageId, {
      roomId,
      type: 'private',
      reactions: {},
    });
```

**For Group Messages**:
```358:362:server/server.js
    messages.set(messageId, {
      groupId,
      type: 'group',
      reactions: {},
    });
```

**Reactions Store Socket IDs**:
```394:399:server/server.js
    if (!message.reactions[emoji]) {
      message.reactions[emoji] = [];
    }

    if (!message.reactions[emoji].includes(socket.id)) {
      message.reactions[emoji].push(socket.id);
    }
```

**Structure**:
```javascript
messages = Map {
  "msg-1" => {
    roomId: "socket-id-1-socket-id-2",
    type: "private",
    reactions: {
      "‚ù§Ô∏è": ["socket-id-1", "socket-id-2"] // Socket IDs who reacted
    }
  },
  "msg-2" => {
    groupId: "group-1",
    type: "group",
    reactions: {
      "üëç": ["socket-id-1"]
    }
  },
  ...
}
```

**Key Points**:
- Messages store metadata, not full message content
- Reactions store arrays of socket IDs who reacted
- Socket IDs are used to track who reacted to which message

---

### **5. Socket.IO Room Management**

**How Socket.IO Stores Socket IDs in Rooms**:

Socket.IO internally manages rooms using socket IDs. When you call:
- `socket.join(roomId)` - Adds `socket.id` to that room
- `io.to(roomId).emit(...)` - Sends to all socket IDs in that room

**Code Examples**:
```146:147:server/server.js
    socket.join(roomId);
    io.to(recipientId).socketsJoin(roomId);
```

```235:235:server/server.js
    socket.join(groupId);
```

```298:299:server/server.js
    group.members.add(socket.id);
    socket.join(groupId);
```

---

## üíª **CLIENT-SIDE STORAGE**

### **1. Clients List** (`client/src/components/ChatInterface.tsx`)

**Data Structure**: `Array<Client>` (React State)
- **File**: `client/src/components/ChatInterface.tsx` (Line 23)
- **Type Definition**: `client/src/types.ts` (Lines 3-7)

**Code Location**:
```23:23:client/src/components/ChatInterface.tsx
  const [clients, setClients] = useState<Client[]>([]);
```

**Type Definition**:
```3:7:client/src/types.ts
export interface Client {
  name: string;
  socketId: string;
  age: number;
}
```

**How Socket IDs are Stored**:
- Each client object in the array contains a `socketId` property
- Received from server via `socket.on("clientList", ...)`
- Updated when clients join/leave

**Structure**:
```javascript
clients = [
  { name: "Alice", socketId: "socket-id-1", age: 25 },
  { name: "Bob", socketId: "socket-id-2", age: 30 },
  ...
]
```

**Current Client's Socket ID**:
```412:412:client/src/components/ChatInterface.tsx
            currentClientId={socket.id || ""}
```
- Accessed via `socket.id` (from Socket.IO client)
- Not stored in state, accessed directly from socket object

---

### **2. Groups List** (`client/src/components/ChatInterface.tsx`)

**Data Structure**: `Array<Group>` (React State)
- **File**: `client/src/components/ChatInterface.tsx` (Line 24)
- **Type Definition**: `client/src/types.ts` (Lines 21-27)

**Code Location**:
```24:24:client/src/components/ChatInterface.tsx
  const [groups, setGroups] = useState<Group[]>([]);
```

**Type Definition**:
```21:27:client/src/types.ts
export interface Group {
  groupId: string;
  name: string;
  creator: GroupCreator;
  members: GroupMember[];
  minimumAge?: number;
}
```

**How Socket IDs are Stored**:
```9:13:client/src/types.ts
export interface GroupMember {
  name: string;
  socketId: string;
  age?: number;
}
```

```15:19:client/src/types.ts
export interface GroupCreator {
  name: string;
  socketId: string;
  age?: number;
}
```

**Structure**:
```javascript
groups = [
  {
    groupId: "group-1",
    name: "Study Group",
    creator: { name: "Alice", socketId: "socket-id-1", age: 25 },
    members: [
      { name: "Alice", socketId: "socket-id-1", age: 25 },
      { name: "Bob", socketId: "socket-id-2", age: 30 }
    ],
    minimumAge: 18
  },
  ...
]
```

**Key Points**:
- On server, `members` is a `Set<string>` (socket IDs only)
- On client, `members` is `Array<GroupMember>` (objects with socketId)
- Server converts Set to Array when sending to client

---

### **3. Messages Storage** (`client/src/components/ChatInterface.tsx`)

**Data Structure**: `Map<string, Message[]>` (React State)
- **File**: `client/src/components/ChatInterface.tsx` (Line 26)
- **Key**: `roomId` (for private) or `groupId` (for group)
- **Value**: Array of message objects

**Code Location**:
```26:26:client/src/components/ChatInterface.tsx
  const [messages, setMessages] = useState<Map<string, Message[]>>(new Map());
```

**Type Definition**:
```29:36:client/src/types.ts
export interface Message {
  sender: string;
  message: string;
  timestamp: string;
  isOwn: boolean;
  messageId?: string;
  reactions?: Record<string, string[]>;
}
```

**How Socket IDs are Used**:
```364:376:client/src/components/ChatInterface.tsx
  const getCurrentMessages = (): Message[] => {
    if (!activeChat) return [];

    let messageKey: string;
    if (activeChat.type === "private") {
      const roomId = [socket.id, activeChat.id].sort().join("-");
      messageKey = roomId;
    } else {
      messageKey = activeChat.id;
    }

    return messages.get(messageKey) || [];
  };
```

**Structure**:
```javascript
messages = Map {
  "socket-id-1-socket-id-2" => [
    {
      sender: "Alice",
      message: "Hello!",
      timestamp: "2024-01-01T12:00:00Z",
      isOwn: true,
      messageId: "msg-1",
      reactions: { "‚ù§Ô∏è": ["socket-id-1"] }
    },
    ...
  ],
  "group-1" => [
    {
      sender: "Bob",
      message: "Hi everyone!",
      timestamp: "2024-01-01T12:01:00Z",
      isOwn: false,
      messageId: "msg-2",
      reactions: {}
    },
    ...
  ]
}
```

**Key Points**:
- Messages are organized by room/group ID
- `isOwn` is determined by comparing `sender.socketId === socket.id`
- Reactions contain arrays of socket IDs

---

### **4. Active Chat** (`client/src/components/ChatInterface.tsx`)

**Data Structure**: `ActiveChat | null` (React State)
- **File**: `client/src/components/ChatInterface.tsx` (Line 25)
- **Type Definition**: `client/src/types.ts` (Lines 38-42)

**Code Location**:
```25:25:client/src/components/ChatInterface.tsx
  const [activeChat, setActiveChat] = useState<ActiveChat | null>(null);
```

**Type Definition**:
```38:42:client/src/types.ts
export interface ActiveChat {
  type: 'private' | 'group';
  id: string; // socketId for private, groupId for group
  name: string;
}
```

**How Socket IDs are Stored**:
```263:267:client/src/components/ChatInterface.tsx
    setActiveChat({
      type: "private",
      id: recipient.socketId, // Socket ID stored here
      name: recipient.name,
    });
```

**Structure**:
```javascript
activeChat = {
  type: "private",
  id: "socket-id-2", // Socket ID of the other person
  name: "Bob"
}
// OR
activeChat = {
  type: "group",
  id: "group-1", // Group ID
  name: "Study Group"
}
```

---

### **5. Typing Users** (`client/src/components/ChatInterface.tsx`)

**Data Structure**: `Map<string, Set<string>>` (React State)
- **File**: `client/src/components/ChatInterface.tsx` (Line 28)
- **Key**: `roomId` or `groupId`
- **Value**: Set of user names (not socket IDs)

**Code Location**:
```28:28:client/src/components/ChatInterface.tsx
  const [typingUsers, setTypingUsers] = useState<Map<string, Set<string>>>(new Map());
```

**Structure**:
```javascript
typingUsers = Map {
  "socket-id-1-socket-id-2" => Set { "Alice", "Bob" },
  "group-1" => Set { "Alice" }
}
```

**Note**: This stores user names, not socket IDs, but is keyed by room/group IDs that contain socket IDs.

---

## üìä **Data Flow Summary**

### **Server ‚Üí Client Data Transfer**

1. **Client Registration**:
   - Server stores: `clients.set(socket.id, { name, socketId, age })`
   - Server sends: `socket.emit("clientList", clientList)` (array with socketIds)

2. **Group Creation**:
   - Server stores: `groups.set(groupId, { members: Set([socket.id]) })`
   - Server sends: `io.emit("groupCreated", groupResponse)` (array with socketIds in members)

3. **Messages**:
   - Server stores: `messages.set(messageId, { roomId, type, reactions })`
   - Server sends: `io.to(roomId).emit("privateMessage", messageData)` (includes sender.socketId)

### **Client ‚Üí Server Data Transfer**

1. **Registration**: Client sends `{ name, age }`, server assigns `socket.id`
2. **Private Message**: Client sends `{ recipientId: socket.id, message }`
3. **Group Message**: Client sends `{ groupId, message }`
4. **Join Group**: Client sends `{ groupId }`, server adds `socket.id` to members Set

---

## üîë **Key Files Reference**

| Data Type | Server File | Client File | Type Definition File |
|-----------|-------------|-------------|---------------------|
| **Clients** | `server/server.js` (Line 49) | `client/src/components/ChatInterface.tsx` (Line 23) | `client/src/types.ts` (Lines 3-7) |
| **Groups** | `server/server.js` (Line 50) | `client/src/components/ChatInterface.tsx` (Line 24) | `client/src/types.ts` (Lines 21-27) |
| **Messages** | `server/server.js` (Line 53) | `client/src/components/ChatInterface.tsx` (Line 26) | `client/src/types.ts` (Lines 29-36) |
| **Private Rooms** | `server/server.js` (Line 52) | N/A (derived from messages) | N/A |
| **Active Chat** | N/A | `client/src/components/ChatInterface.tsx` (Line 25) | `client/src/types.ts` (Lines 38-42) |
| **Socket Object** | `server/server.js` (via `io.on("connection")`) | `client/src/App.tsx` (Line 7) | Socket.IO types |

---

## üí° **Important Notes**

1. **Socket IDs are Generated by Socket.IO**:
   - Automatically generated when client connects
   - Unique per connection
   - Format: Usually alphanumeric string (e.g., `"abc123xyz"`)

2. **Server Uses Maps and Sets for Performance**:
   - `Map`: O(1) lookup by key
   - `Set`: O(1) membership check
   - Arrays converted when sending to client

3. **Client Uses Arrays for Rendering**:
   - Easier to map over in React
   - Server converts Sets to Arrays before sending

4. **Room IDs Contain Socket IDs**:
   - Private rooms: `"socket-id-1-socket-id-2"` (sorted)
   - Group rooms: `"group-1"` (group ID)

5. **Socket IDs are Primary Keys**:
   - Used to identify clients
   - Used to check group membership
   - Used to route messages
   - Used to track reactions

---

## üîç **How to Access Socket ID**

### **On Server**:
```javascript
// In any socket event handler
socket.id  // Current client's socket ID
```

### **On Client**:
```javascript
// In React components
socket.id  // Current client's socket ID (from Socket.IO client)
```

### **Example Usage**:
```javascript
// Server: Get client by socket ID
const client = clients.get(socket.id);

// Server: Check if socket ID is in group
if (group.members.has(socket.id)) { ... }

// Client: Compare with own socket ID
if (client.socketId === socket.id) { ... }
```

---

This document provides a complete overview of how socket IDs and all other data are stored throughout the application! üéØ

